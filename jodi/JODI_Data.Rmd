---
title: "Trends in the JODI Dataset"
output: html_document
---

# Dataset

In this write up, we are going to explore data provided by the Joint Organisations Data Initiative (JODI), which is an international organization that provides open data about oil and natural gas. The first data gathering exercise was launched in 2001 and many countries participated, adding up to an estimated coverage of about 90% world supply. 

The dataset we are going to use is the World Primary dataset, which can be downloaded from the [Data Downloads](https://www.jodidata.org/oil/database/data-downloads.aspx) page on the JODI website.
The World Primary dataset contains data about Crude Oil, Natural Gas Liquids (NGL), and other primary sources (Other). The World Secondary dataset contains data about secondary products such as Gas/diesel oil, Fuel oil, etc.

```{r load-jodi, echo=FALSE}
jodi <- read.csv('world_Primary_CSV.csv')
```

The analysis that follows was performed using R with the following libraries:
```{r load-packages, message=FALSE}
library(knitr)
library(dplyr)
library(ggplot2)
```

The variables we are going to use in this write up are: country, year, and quantity, product, flow, and unit. As a preprocessing step, the dataset was filtered by date to only include the past ten years and also remove the current year (2017).

```{r, echo=FALSE}
add_year <- function(dataset) {
  return(dataset %>%
    mutate(year = strtoi(substr(dataset$date, 4, 8))) %>%
    filter(year != 2017))
}

jodi <- add_year(jodi)
jodi <- filter(jodi, year > 2006)

group_by_year <- function(dataset) {
  return(dataset %>%
    group_by(year) %>%
    summarise(quantity = sum(quantity)))
} 
```

## Products

The available primary products are ...

```{r, echo=FALSE}
jodi_us <- filter(jodi, country == 'USA', unit == 'KBBL', flow == 'PRODREFOUT')

jodi_us_prod_by_year <- jodi_us %>%
  group_by(year, product) %>%
  summarise(quantity = sum(quantity)) %>%
  mutate(quantity = quantity / 1000)

ggplot(jodi_us_prod_by_year, aes(year, quantity)) +   
  geom_bar(aes(fill = product), position = "dodge", stat="identity") +
  ggtitle(label = "US All Oil Products", subtitle = NULL) +
  labs(x = "Year", y = 'Quantity (Millions of Barrels)') +
  scale_x_continuous(breaks = pretty(jodi_us_prod_by_year$year, n = 10))
```

# World Producers

In this section we are going to find out which countries are the top producers.


Three countries are definitely the top producers: Saudi Arabia, Russia, and the United States. Iraq, China, and Iran complete the top 5 across the last three years, although their output is around a third of Saudi Arabia.


Iraq has come up a lot. Venezuela has come down. Expand on this.

```{r, echo=FALSE}
country_yearly_stats <- function(dataset, yearToFilter) {
  return(dataset %>%
    filter(year == yearToFilter) %>%
    group_by(country))
}

jodi_prod <- filter(jodi, flow == 'PRODREFOUT', product == 'CRUDEOIL', unit == 'KBBL')
jodi_prod <- mutate(jodi_prod, quantity = quantity / 1000)

table2016 <- country_yearly_stats(jodi_prod, 2016) %>%
  summarise(quantity2016 = sum(quantity)) %>%
  mutate(quantity2016 = round(quantity2016)) %>%
  arrange(desc(quantity2016))

table2015 <- country_yearly_stats(jodi_prod, 2015) %>%
  summarise(quantity2015 = sum(quantity)) %>%
  mutate(quantity2015 = round(quantity2015)) %>%
  arrange(desc(quantity2015))

table2014 <- country_yearly_stats(jodi_prod, 2014) %>%
  summarise(quantity2014 = sum(quantity)) %>%
  mutate(quantity2014 = round(quantity2014)) %>%
  arrange(desc(quantity2014))

table2013 <- country_yearly_stats(jodi_prod, 2013) %>%
  summarise(quantity2013 = sum(quantity)) %>%
  mutate(quantity2013 = round(quantity2013)) %>%
  arrange(desc(quantity2013))

with_2015 <- left_join(table2016, table2015, by = "country")
with_2014 <- left_join(with_2015, table2014, by = "country")
with_2013 <- left_join(with_2014, table2013, by = "country")

kable(with_2013[1:15,], caption = 'Top 15 Crude Oil Producers (Millions of Barrels)', col.names = c("Country", "2016", "2015", "2014", "2013"))
```

If we only look at the three major producers, we can see that the United States has recovered a lot of ground in the last few years:

```{r, echo=FALSE}
jodi_prod <- filter(jodi, flow == 'PRODREFOUT', product == 'CRUDEOIL', unit == 'KBBL', 
                    country == 'USA' | country == 'RUSSIA' | country == 'SARABIA')
quantity_by_year_and_country <- jodi_prod %>%
  mutate(quantity = quantity / 1000) %>%
  group_by(year, country) %>%
  summarise(quantity = sum(quantity))

ggplot(quantity_by_year_and_country, aes(year, quantity)) +   
  geom_bar(aes(fill = country), position = "dodge", stat="identity") +
  ggtitle(label = "Crude Oil Top 3 Producers", subtitle = NULL) +
  labs(x = "Year", y = 'Quantity (Millions of Barrels)') +
  scale_x_continuous(breaks = pretty(quantity_by_year_and_country$year, n = 10))
```

# World Production

TODO Make this a line graph.

```{r, echo=FALSE}
jodi_prod_and_use <- filter(jodi, product == 'CRUDEOIL', unit == 'KBBL', !is.na(quantity))
by_year <- jodi_prod_and_use %>%
  mutate(quantity = quantity / 1000) %>%
  group_by(year, product) %>%
  summarise(quantity = sum(quantity))

ggplot(by_year, aes(year, quantity)) +   
  geom_bar(aes(fill = product), position = "dodge", stat="identity") +
  ggtitle(label = "Production and Direct Use", subtitle = NULL) +
  labs(x = "Year", y = 'Quantity (Millions of Barrels)') +
  scale_x_continuous(breaks = pretty(by_year$year, n = 10))
```

```{r, echo=FALSE}
country_yearly_graph <- function(queryCountry) {
  jodi_prod <- filter(jodi, country == queryCountry, 
                       flow == 'PRODREFOUT' | flow == 'TOTEXPSB' | flow == 'TOTIMPSB', 
                       product == 'CRUDEOIL', unit == 'KBBL')

jodi_us_prod_by_year <- jodi_prod %>%
  group_by(year, flow) %>%
  summarise(quantity = sum(quantity)) %>%
  mutate(quantity = quantity / 1000)

ggplot(jodi_us_prod_by_year, aes(year, quantity)) +   
  geom_bar(aes(fill = flow), position = "dodge", stat="identity") +
  ggtitle(label = "", subtitle = NULL) +
  labs(x = "Year", y = 'Quantity (Millions of Barrels)') +
  scale_x_continuous(breaks = pretty(jodi_us_prod_by_year$year, n = 10)) +
  scale_fill_discrete(
    name = "Flow",
    breaks = c("PRODREFOUT", "TOTEXPSB", "TOTIMPSB"),
    labels = c("Production", "Exports", "Imports"))
} 
```

# Individual Countries

## Production, Imports, and Exports

### Saudi Arabia

Saudi Arabia is the world top producer.

```{r, echo=FALSE}
country_yearly_graph('SARABIA')
```

### Russia

```{r, echo=FALSE}
country_yearly_graph('RUSSIA')
```

### United States

The United States has seen a boom in oil production after 2010, which is commonly attributed to the technological advances in horizontal drilling and hydraulic fracturing. The graph also shows declining imports and rising exports, although they are still very small when compared to production and imports. 
 
```{r, echo=FALSE}
country_yearly_graph('USA')
```

### Iraq

```{r, echo=FALSE}
country_yearly_graph('IRAQ')
```

### Venezuela

```{r, echo=FALSE}
country_yearly_graph('VENEZOPEC')
```